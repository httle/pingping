{% extends 'base.html' %}
{% block title %}乒乒乓乓{% endblock %}
{% block nav_blog_active %}active{% endblock %}
{% load staticfiles %}
<!-- 加载模板标签 -->
{% load comment_tags %}
{% load likes_tags %}

{% block head_extra %}
    <link rel="stylesheet" type="text/css" href="{% static 'privateletter.css' %}">
    <script type="text/javascript" src="{% static 'ckeditor/ckeditor-init.js' %}"></script>
    <script type="text/javascript" src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
    <script type="text/javascript" src="{% static 'privateletter.js' %}"></script>
    <style type="text/css">
    .message_left{
        width: fit-content;
        max-width: 400px;
        margin-right:auto;
        word-wrap:break-word;
        display: block;
        text-align: left;
        padding: 10px;
        border: 2px solid #000;
        margin-top: 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        margin-left: 10px;
    }
    .message_right{
        width: fit-content;
        max-width: 400px;
        /*position: fixed;
        right: 0;*/
        margin-left: auto;
        word-wrap:break-word;
        display:block;
        text-align: left;
        padding: 10px;
        border: 2px solid #000;
        margin-top: 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        margin-right: 10px;
    }
    </style>
{% endblock %}
    <!-- 页面内容 -->

{% block content %}
<div>CNM</div>
{% endblock %}

{% block script_extends %}
<script type="text/javascript" >
    function test(){
        alert("NMD");
    }

    function friendNotifyList(){
        $.ajax({
            url:"{% url 'friendNotifyList' %}",
            type:'GET',
            data:{},
            cache:false,
            success:function(data){
                console.log(data)
                $(".chat-main").empty();
                for(var i=0;i<data["data"].length;i++){
                    var message_html = '<div class="friend_notify_list" ><div class="pull-left">'+data["data"][i]["sender"]+'申请加你为好友</div><button class="pull-right agree" onclick="friendProcess(this,1,+'+data["data"][i]["pk"]+')">同意</button><button class="pull-right reject" onclick="friendProcess(this,0,'+data["data"][i]["pk"]+')">拒绝</button></div>';
                    // console.log(message_html);
                    $(".chat-main").append(message_html);
                };
                $(".chat-main").scrollTop($(".chat-main").height());
            },
            error:function(xhr){

            },
        })
    }

    function friendProcess(obj,mode,pk){
        console.log(pk);
        $.ajax({
            url:"{% url 'friendProcess' %}",
            type:"GET",
            cache:false,
            data:{
                mode:mode,
                id:pk,
            },
            success:function(data){
                console.log(data);
                var container = $(obj).parents(".friend_notify_list");
                container.remove();
                if(mode==1){
                    var html_friend = '<div class="friend" >'+data["friend"]+'</div>';
                    $(".frineds-list").append(html_friend);
                }
            },
            error:function(xhr){
                console.log(xhr);
            }
        })
    }

    function startChat(chatobjid){
        $.ajax({
            url:"{% url 'startChat' %}",
            type:'GET',
            cache:false,
            data:{
                chatobjid:chatobjid,
            },
            success:function(data){
                console.log(data);
                if(data["status"]==1){
                    if(data["ifhave"]==1){
                        $(".friend_icon").removeClass("bottom_hr");
                        $(".chat_icon").addClass("bottom_hr");
                        $(".frineds-list").addClass("op");
                        $(".chats-list").removeClass("op");
                        $(".chat-main").empty();
                        // id = "#"+data["id"];
                        $("div[name='"+data["id"]+"']").attr("class","chat_selected");
                        for(var i=0;i<data["data"].length;i++){
                            if(data["data"][i]["ifsender"]==1){
                                var message_html = '<div class="message_right" align="right">'+data["data"][i]["text"]+'</div>';
                            }else{
                                var message_html = '<div class="message_left" align="left">'+data["data"][i]["text"]+'</div>';
                            }
                            
                            console.log(message_html);
                            $(".chat-main").append(message_html);
                        };
                    }
                }
            },
            error:function(xhr){
                console.log(xhr);
            }
        })
    }

    function getChatMes(object,id){
        // alert("NMD");
        $(".chat_selected").attr("class","chat_not_selected");
        $(object).attr("class","chat_selected");
        $(".chatid").attr("id",id);
        $.ajax({
            url: "{% url 'chatMessage' %}",
            type:'GET',
            data:{
                id:id,
            },
            async:false,
            cache:false,
            success:function(data){
                
                console.log(1);
                console.log(data);
                $(".chat-main").empty();
                for(var i=0;i<data["chatMessage"].length;i++){
                    if(data["chatMessage"][i]["ifsender"]==1){
                        var message_html = '<div class="message_right" align="right">'+data["chatMessage"][i]["text"]+'</div>';
                    }else{
                        var message_html = '<div class="message_left" align="left">'+data["chatMessage"][i]["text"]+'</div>';
                    }
                    
                    console.log(message_html);
                    $(".chat-main").append(message_html);
                };
                $(".chat-main").scrollTop($(".chat-main").height());
                id = '#'+data["chatId"];
                console.log(id);
                $(id).text('');
            },
            error: function(xhr){
                console.log(xhr);
                
            },
        });
    }

    function sendChatMes(){
        var name = $("#user").val();
        console.log(name);
        var formData = new FormData();
        id = $(".chatid").attr("id");
        // console.log($(".chatid").id);
        $("#post_error").text('');
        if($('#post_text').val().trim()==''){
            $("#post_error").text("内容不能为空");
            return false;
        }
        var text = $('#post_text').val();
        console.log(text,id);
        // formData.append('text',$('textarea[name="content"]').val().trim());
        // formData.append('id',id);
        $.ajax({
            url:"{% url 'sendChatMes'%}",
            type:'GET',
            data:{
                id:id,
                text:text,
                name:name,
            },
            // contentType: false,  
            // processData: false,
            cache:false,
            success:function(data){
                console.log(data);
                if(data['status']=="success"){
                    var message_html = '<div class="message_right" align="right">'+text+'</div>';
                    $(".chat-main").append(message_html);
                    $('#post_text').val('');
                    $(".chat-main").scrollTop($(".chat-main").height());
                }
            },
            error:function(xhr){
                // console.log(xhr);
                return false;
            }
        });
    };

    var mesChange = {
        alarm_Timer:null,
        mesNotify:function(){
            var id = $(".chatid").attr("id");
            $.ajax({
                url:"{% url 'webNotify' %}",
                type:'GET',
                data:{
                    id:id,
                },
                cache:false,
                success:function(data){
                    console.log(data)
                    for(var i=0;i<data["text"].length;i++){
                        var message_html = '<div class="message_left" align="left">'+data["text"][i]["text"]+'</div>';
                        $(".chat-main").append(message_html);
                    };
                    $(".chat-main").scrollTop($(".chat-main").height());
                    for(var i=0;i<data["data"].length;i++){
                        if(data["data"][i]["unreadnum"]!=0){
                            chatid = "#"+data["data"][i]["pk"];
                            $(chatid).text(data["data"][i]["unreadnum"]);
                        }
                    };
                },
                error:function(xhr){
                    console.log(xhr)
                }
            });
        },
    };
    mesChange.alarm_Timer = setInterval(mesChange.mesNotify,5000);

    $(document).ready(function(){
            $(".friend_icon").click(function(){
                $(".chat-main").empty();
                $(".chat_selected").attr("class","chat_not_selected");
                $(".chat_icon").removeClass("bottom_hr");
                $(this).addClass("bottom_hr");
                $(".frineds-list").removeClass("op");
                $(".chats-list").addClass("op");
                
            })

            $(".chat_icon").click(function(){
                $(".friend_icon").removeClass("bottom_hr");
                $(this).addClass("bottom_hr");
                $(".frineds-list").addClass("op");
                $(".chats-list").removeClass("op");
            })
        });
</script>

{% endblock %}

