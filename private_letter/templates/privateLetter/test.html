{% extends 'base.html' %}
{% block title %}乒乒乓乓{% endblock %}
{% block nav_blog_active %}active{% endblock %}
{% load staticfiles %}
<!-- 加载模板标签 -->
{% load comment_tags %}
{% load likes_tags %}
{% block head_extra %}
    <link rel="stylesheet" type="text/css" href="{% static 'privateletter.css' %}">
    <script type="text/javascript" src="{% static 'ckeditor/ckeditor-init.js' %}"></script>
    <script type="text/javascript" src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
    <script type="text/javascript" src="{% static 'privateletter.js' %}"></script>
    <style type="text/css">
        
    </style>
{% endblock %}
    <!-- 页面内容 -->

{% block content %}
<div class="container">
    <div class="header">
        <span id="hello_text"></span>
    </div>
    <div class="body">
        <div class="all-list">
            <div class="list-header">
                <span class="glyphicon glyphicon-envelope" onclick="test()">私信消息</span>
            </div>
            <div class="select-icon">
                <div class="chat_icon bottom_hr">
                    <span class="glyphicon glyphicon-comment"></span>
                </div>
                <div style="border: 1px solid #000;"></div>
                <div class="friend_icon">
                    <span class="glyphicon glyphicon-user"></span>
                </div>
            </div>
            <div class="frineds-list op" >
                {% for friend in friends %} 
                    {% if user == friend.user1 %}
                        <div class="friend" >{{ friend.user2 }}</div>
                    {% else %}
                        <div class="friend">{{ friend.user1 }}</div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="chats-list" >
                {% for chat in chats %} 
                    {% if user == chat.user1 %}
                        <div class="chat_not_selected" onclick="getChatMes(this,{{chat.pk}})">{{ chat.user2 }}<span class="badge unread-count chatmes" id="{{chat.pk}}">{% if chat.unread > 0 %}{{ chat.unread }}{% endif %}</div>
                    {% else %}
                        <div class="chat_not_selected" onclick="getChatMes(this,{{chat.pk}})">{{ chat.user1 }}{{ chat.user2 }}<span class="badge unread-count chatmes" id="{{chat.pk}}">{% if chat.unread > 0 %}{{ chat.unread }}{% endif %}</div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <div class="chat">
            <div class="chat-main"></div>
            <div class="chat-send">
                <!-- <form id="post_chat" action="{% url 'sendChatMes'%}" method="POST" style="overflow: hidden;" ENCTYPE="multipart/form-data">
                    {% csrf_token %}
                    <div class="postChat">
                        <div class="chatid" id=""></div>
                        <div class="form-group">
                            <textarea id="post_text" name="content" class="form-control" placeholder="在这里输入你想说的话吧~" rows="5" ></textarea>
                            <span id="post_error" class="text-danger pull-left"></span>
                        </div>
                    </div>
                    <div>
                        <input type="submit" value="私信" class="btn btn-primary pull-right">
                    </div>
                </form> -->
                <div class="postChat">
                    <div class="chatid" id=""></div>
                    <div class="form-group">
                        <textarea id="post_text" name="content" class="form-control" placeholder="在这里输入你想说的话吧~" rows="5" ></textarea>
                        <span id="post_error" class="text-danger pull-left"></span>
                    </div>
                </div>
                <div>
                    <!-- <div id="user" style="display: none;"></div> -->
                    <textarea id="user" style="display: none;">{{user.username}}</textarea>
                    <button  value="私信" class="btn btn-primary pull-right submit" onclick="sendChatMes()">发送</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script_extends %}
<script type="text/javascript" >
    function test(){
        alert("NMD");
    }


    function getChatMes(object,id){
        // alert("NMD");
        $(".chat_selected").attr("class","chat_not_selected");
        $(object).attr("class","chat_selected");
        $(".chatid").attr("id",id);
        $.ajax({
            url: "{% url 'chatMessage' %}",
            type:'GET',
            data:{
                id:id,
            },
            async:false,
            cache:false,
            success:function(data){
                
                console.log(1);
                console.log(data);
                $(".chat-main").empty();
                for(var i=0;i<data["chatMessage"].length;i++){
                    if(data["chatMessage"][i]["ifsender"]==1){
                        var message_html = '<div class="message_right" align="right">'+data["chatMessage"][i]["text"]+'</div>';
                    }else{
                        var message_html = '<div class="message_left" align="left">'+data["chatMessage"][i]["text"]+'</div>';
                    }
                    
                    console.log(message_html);
                    $(".chat-main").append(message_html);
                };
                $(".chat-main").scrollTop($(".chat-main").height());
                id = '#'+data["chatId"];
                console.log(id);
                $(id).text('');
            },
            error: function(xhr){
                console.log(xhr);
                
            },
        });
    }

    function sendChatMes(){
        var name = $("#user").val();
        console.log(name);
        var formData = new FormData();
        var id = $(".chatid").attr("id");
        $("#post_error").text('');
        if($('#post_text').val().trim()==''){
            $("#post_error").text("内容不能为空");
            return false;
        }
        var text = $('#post_text').val();
        console.log(text,id);
        // formData.append('text',$('textarea[name="content"]').val().trim());
        // formData.append('id',id);
        $.ajax({
            url:"{% url 'sendChatMes'%}",
            type:'GET',
            data:{
                id:id,
                text:text,
                name:name,
            },
            // contentType: false,  
            // processData: false,
            cache:false,
            success:function(data){
                console.log(data);
                if(data['status']=="success"){
                    var message_html = '<div class="message_right" align="right">'+text+'</div>';
                    $(".chat-main").append(message_html);
                    $('#post_text').val('');
                    $(".chat-main").scrollTop($(".chat-main").height());
                }
            },
            error:function(xhr){
                // console.log(xhr);
                return false;
            }
        });
    };

    $(document).ready(function(){
            $(".friend_icon").click(function(){
                $(".chat_icon").removeClass("bottom_hr");
                $(this).addClass("bottom_hr");
                $(".frineds-list").removeClass("op");
                $(".chats-list").addClass("op");
                
            })

            $(".chat_icon").click(function(){
                $(".friend_icon").removeClass("bottom_hr");
                $(this).addClass("bottom_hr");
                $(".frineds-list").addClass("op");
                $(".chats-list").removeClass("op");
            })
        });
</script>
{% endblock %}

